{#
/**
 * @file
 * Default theme implementation to display a config_page.
 *
 * @see template_preprocess_config_pages()
 *
 * @ingroup themeable
 */
#}

<div{{ attributes.addClass('subsite-agenda') }}>

  {# Tab Navigation #}
  {% if content.field_subsite_daily_schedule['#items'] is not empty %}
    {% set daily_schedules = content.field_subsite_daily_schedule['#items'] %}
    
    <div class="agenda-tabs" role="tablist">
      {% for key, day_item in daily_schedules %}
        {% set day_entity = day_item.entity %}
        {% set day_date = day_entity.field_microsite_event_date.value %}
        {% set day_formatted = day_date|date('l, F j') %}
        {% set day_number = key + 1 %}
        {% set tab_id = 'day-' ~ day_number %}

        <button class="agenda-tab {% if loop.first %}active{% endif %}" role="tab" aria-selected="{% if loop.first %}true{% else %}false{% endif %}" aria-controls="{{ tab_id }}--panel" id="{{ tab_id }}--tab" data-tab="{{ tab_id }}">
          <span class="tab-day-number">{{ day_number }}</span>
          <span class="tab-day-name">{{ day_formatted }}</span>
        </button>
      {% endfor %}
    </div>

    {# Tab Content #}
    <div class="agenda-content">
      {% for key, day_item in daily_schedules %}
        {% set day_entity = day_item.entity %}
        {% set day_number = key + 1 %}
        {% set tab_id = 'day-' ~ day_number %}
        {% set schedule_items = day_entity.field_event_daily_schedule %}

        <div class="agenda-panel {% if loop.first %}active{% endif %}" role="tabpanel" id="{{ tab_id }}--panel" aria-labelledby="{{ tab_id }}--tab" {% if not loop.first %}hidden{% endif %}>

          {# Schedule Timeline per day #}
          {% if schedule_items is not empty %}
            <div class="schedule-timeline">
              {% for schedule_key, schedule_item in schedule_items %}
                {% set schedule_entity = schedule_item.entity %}
                
                {# Access time field using getValue() to get raw data array #}
                {% set time_data = schedule_entity.field_microsite_schedule_time.getValue() %}
                {% set time_start_seconds = time_data[0].from ?? time_data[0].value ?? null %}
                {% set time_end_seconds = time_data[0].to ?? time_data[0].end_value ?? null %}
                
                {% set title = schedule_entity.field_microsite_section_title.value %}
                {% set location = schedule_entity.field_microsite_schedule_locate.value %}
                {% set description = schedule_entity.field_microsite_schedule_descrip.value %}
                {% set speakers = schedule_entity.field_microsite_schedule_speaker %}
                
                <div class="schedule-item">
                  <div class="schedule-time">
                    {% if time_start_seconds and time_end_seconds %}
                      {# Convert seconds to hours and minutes #}
                      {% set start_hours = (time_start_seconds / 3600)|round(0, 'floor') %}
                      {% set start_minutes = ((time_start_seconds % 3600) / 60)|round(0, 'floor') %}
                      {% set end_hours = (time_end_seconds / 3600)|round(0, 'floor') %}
                      {% set end_minutes = ((time_end_seconds % 3600) / 60)|round(0, 'floor') %}
                      
                      {# Format as 12-hour time #}
                      {% set start_period = start_hours >= 12 ? 'PM' : 'AM' %}
                      {% set start_display_hour = start_hours > 12 ? start_hours - 12 : (start_hours == 0 ? 12 : start_hours) %}
                      {% set end_period = end_hours >= 12 ? 'PM' : 'AM' %}
                      {% set end_display_hour = end_hours > 12 ? end_hours - 12 : (end_hours == 0 ? 12 : end_hours) %}
                      
                      {{ start_display_hour }}:{{ '%02d'|format(start_minutes) }} {{ start_period }} - {{ end_display_hour }}:{{ '%02d'|format(end_minutes) }} {{ end_period }}
                    {% elseif time_start_seconds %}
                      {# Convert seconds to hours and minutes #}
                      {% set start_hours = (time_start_seconds / 3600)|round(0, 'floor') %}
                      {% set start_minutes = ((time_start_seconds % 3600) / 60)|round(0, 'floor') %}
                      
                      {# Format as 12-hour time #}
                      {% set start_period = start_hours >= 12 ? 'PM' : 'AM' %}
                      {% set start_display_hour = start_hours > 12 ? start_hours - 12 : (start_hours == 0 ? 12 : start_hours) %}
                      
                      {{ start_display_hour }}:{{ '%02d'|format(start_minutes) }} {{ start_period }}
                    {% endif %}
                  </div>
                  
                  <div class="schedule-details">
                    {% if title %}
                      <h3 class="schedule-title">{{ title }}</h3>
                    {% endif %}
                    
                    {% if location %}
                      <div class="schedule-location">
                        <span>{{ location }}</span>
                      </div>
                    {% endif %}
                    
                    {% if description %}
                      <div class="schedule-description">
                        {{ description|raw }}
                      </div>
                    {% endif %}
                    
                    {% if speakers is not empty %}
                      <div class="schedule-speakers">
                        <strong>Speaker(s):</strong>
                        {% for speaker_key, speaker in speakers %}
                          {{ speaker.value }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="no-schedule">No events scheduled for this day.</p>
          {% endif %}
          
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="no-schedule">No schedule available at this time.</p>
  {% endif %}
  
</div>

{# Add inline JavaScript for tab functionality #}
<script>
(function() {
  const tabs = document.querySelectorAll('.agenda-tab');
  const panels = document.querySelectorAll('.agenda-panel');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const targetId = this.getAttribute('data-tab');
      
      // Remove active class from all tabs and panels
      tabs.forEach(t => {
        t.classList.remove('active');
        t.setAttribute('aria-selected', 'false');
      });
      panels.forEach(p => {
        p.classList.remove('active');
        p.setAttribute('hidden', '');
      });
      
      // Add active class to clicked tab and corresponding panel
      this.classList.add('active');
      this.setAttribute('aria-selected', 'true');
      
      const targetPanel = document.getElementById(targetId + '--panel');
      if (targetPanel) {
        targetPanel.classList.add('active');
        targetPanel.removeAttribute('hidden');
      }
    });
  });
})();
</script>
