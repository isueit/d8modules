<?php

/*
 * Implements hook_ENTITY_TYPE_update()
 */

use Drupal\contact\Entity\Message;
use Drupal\Core\Form\FormStateInterface;
use Drupal\file\Entity\File;
use Drupal\media\Entity\Media;
use Drupal\paragraphs\Entity\Paragraph;

/**
 * Implements hook_entity_presave().
 */

function county_impact_report_node_presave(Drupal\Core\Entity\EntityInterface $entity)
{
  $userId = \Drupal::currentUser()->id();
  if ($entity->getType() == 'county_impact_report') {
    $entity->setOwnerId($userId);
  }
}

/*
 * Not sure this function ever gets called
 */
function county_impact_report_content_update(Drupal\Core\Entity\EntityInterface $entity)
{
  // Clear cache if BlockContent is of type
  if ($entity->bundle() == 'county_impact_remport') {
    \Drupal::service('cache.render')->invalidateAll();
  }
}

function county_impact_report_theme_suggestions_block_alter(&$suggestions, $variables)
{
  $content = $variables['elements']['content'];
  if (isset($content['#block_content']) && $content['#block_content'] instanceof \Drupal\block_content\BlockContentInterface) {
    $suggestions[] = 'block__' . $content['#block_content']->bundle();
  }
}

function county_impact_report_preprocess_block(&$variables)
{
  if ($variables['plugin_id'] == 'extra_field_block:node:county_impact_report:links') {
    $variables['#attached']['library'][] = 'county_impact_report/county_impact_report';
  }
}

/**
 * Implements hook_theme().
 */
function county_impact_report_theme($existing, $type, $theme, $path)
{
  return [
    'paragraph__county_impact_story' => [
      'variables' => [
        'top_impact_data' => [],
      ],
      'template' => 'paragraph--county-impact-story',
      'base hook' => 'paragraph',
    ],
    'page__type__county_impact_report__canonical' => [
      'variables' => [
        'bottom_impact_data' => [],
        'first_paragraph_id' => 0,
        'last_paragraph_id' => 0,
      ],
      'template' => 'page--type--county-impact-report--canonical',
      'base hook' => 'node',
    ],
  ];
}

/**
 * Implements hook_preprocess_HOOK().
 */

function county_impact_report_preprocess_paragraph__county_impact_story(&$variables)
{
  // Get the impact data
  $impactData = county_impact_report_find_county_impacts();
  $impacts = [];
  $impacts[0]['label'] = $impactData[0][1];
  $impacts[0]['icon'] = county_impact_report_find_icon($impactData[0][1]);
  $impacts[0]['value'] = county_impact_report_format_value($impactData[1][1], $impactData[0][1]);
  $impacts[1]['label'] = $impactData[0][5];
  $impacts[1]['icon'] = county_impact_report_find_icon($impactData[0][5]);
  $impacts[1]['value'] = county_impact_report_format_value($impactData[1][5], $impactData[0][5]);
  $impacts[2]['label'] = $impactData[0][4];
  $impacts[2]['icon'] = county_impact_report_find_icon($impactData[0][4]);
  $impacts[2]['value'] = county_impact_report_format_value($impactData[1][4], $impactData[0][4]);
  $variables['top_impact_data'] = $impacts;

  // Get the first and last id of the paragraphs on the page
  $variables['first_paragraph_id'] = 0;
  $variables['last_paragraph_id'] = 0;
  $node = \Drupal::routeMatch()->getParameter('node');
  if ($node instanceof \Drupal\node\NodeInterface) {
    $paragraphs = $node->get('field_impact_story')->getValue();
    foreach ($paragraphs as $paragraph) {
      if ($variables['first_paragraph_id'] == 0) {
        $variables['first_paragraph_id'] = $paragraph['target_id'];
      }
      $variables['last_paragraph_id'] = $paragraph['target_id'];
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */

function county_impact_report_preprocess_page__type__county_impact_report__canonical(&$variables)
{
  // Get the impact data
  $impactData = county_impact_report_find_county_impacts();
  $impacts = [];
  $impacts[0]['label'] = $impactData[0][3];
  $impacts[0]['icon'] = county_impact_report_find_icon($impactData[0][3]);
  $impacts[0]['value'] = county_impact_report_format_value($impactData[1][3], $impactData[0][3]);
  $impacts[1]['label'] = $impactData[0][2];
  $impacts[1]['icon'] = county_impact_report_find_icon($impactData[0][2]);
  $impacts[1]['value'] = county_impact_report_format_value($impactData[1][2], $impactData[0][2]);
  $impacts[2]['label'] = $impactData[0][6];
  $impacts[2]['icon'] = county_impact_report_find_icon($impactData[0][6]);
  $impacts[2]['value'] = county_impact_report_format_value($impactData[1][6], $impactData[0][6]);
  $variables['bottom_impact_data'] = $impacts;
}

function county_impact_report_impact_data()
{
  return [
    'Adair' => [4720, 981, 640, 12, 404, 28331.28,],
    'Adams' => [1958, 257, 241, 16, 121, 7422.16,],
    'Allamakee' => [7093, 815.25, 730, 31, 478, 23544.42,],
    'Appanoose' => [4806, 1494, 678, 24, 281, 43146.72,],
    'Audubon' => [3842, 711.5, 423, 11, 242, 20548.12,],
    'Benton' => [8460, 1758.45, 1809, 26, 918, 50784.04,],
    'Black Hawk' => [19909, 5697.44, 5579, 113, 3829, 164542.07,],
    'Boone' => [10205, 2907.4, 1918, 42, 877, 83965.71,],
    'Bremer' => [11787, 2099.25, 1720, 55, 787, 60626.34,],
    'Buchanan' => [9155, 1614.72, 1817, 27, 785, 46633.11,],
    'Buena Vista' => [4084, 1663.5, 735, 29, 554, 48041.88,],
    'Butler' => [4363, 1368.5, 511, 29, 416, 39522.28,],
    'Calhoun' => [4398, 876, 604, 17, 264, 25298.88,],
    'Carroll' => [11139, 1366, 4195, 28, 887, 39450.08,],
    'Cass' => [7047, 1574.9, 1056, 20, 596, 45483.11,],
    'Cedar' => [6768, 2867.5, 1859, 26, 679, 82813.40,],
    'Cerro Gordo' => [11938, 1344.2, 5115, 19, 1614, 38820.50,],
    'Cherokee' => [3683, 715.45, 499, 16, 527, 20662.20,],
    'Chickasaw' => [3268, 913, 431, 8, 529, 26367.44,],
    'Clarke' => [3180, 1065.95, 243, 16, 318, 30784.64,],
    'Clay' => [8288, 1029.5, 3049, 22, 722, 29731.96,],
    'Clayton' => [9416, 8920.5, 1226, 21, 659, 257624.04,],
    'Clinton' => [8466, 4852.05, 578, 21, 1038, 140127.20,],
    'Crawford' => [4644, 1443, 346, 11, 503, 41673.84,],
    'Dallas' => [17635, 9290.3, 1152, 36, 3483, 268303.86,],
    'Davis' => [3738, 2878.25, 709, 3, 188, 83123.86,],
    'Decatur' => [2816, 835, 229, 6, 216, 24114.80,],
    'Delaware' => [16671, 5878.75, 2652, 23, 681, 169778.30,],
    'Des Moines' => [10230, 3142.54, 436, 16, 1830, 90756.56,],
    'Dickinson' => [8636, 689.75, 2607, 41, 510, 19919.98,],
    'Dubuque' => [36476, 7915.05, 7789, 137, 3661, 228586.64,],
    'East Pottawattamie' => [5540, 89.25, 489, 28, 116, 2577.54,],
    'Emmet' => [3442, 328, 200, 8, 276, 9472.64,],
    'Fayette' => [11141, 2326.8, 1031, 71, 616, 67197.98,],
    'Floyd' => [9301, 1354, 1240, 25, 405, 39103.52,],
    'Franklin' => [5399, 99.9, 777, 19, 376, 2885.11,],
    'Fremont' => [4220, 399.5, 330, 22, 178, 11537.56,],
    'Greene' => [5191, 1500, 341, 36, 358, 43320.00,],
    'Grundy' => [5520, 3829, 874, 38, 540, 110581.52,],
    'Guthrie' => [4838, 965, 487, 8, 369, 27869.20,],
    'Hamilton' => [6962, 1478.18, 750, 28, 428, 42689.84,],
    'Hancock' => [6964, 551.5, 613, 20, 392, 15927.32,],
    'Hardin' => [4074, 77, 335, 8, 376, 2223.76,],
    'Harrison' => [4571, 1078.7, 493, 30, 468, 31152.86,],
    'Henry' => [10724, 1354.2, 3305, 45, 553, 39109.30,],
    'Howard' => [5493, 1019, 601, 9, 538, 29428.72,],
    'Humboldt' => [4304, 1052.25, 672, 4, 261, 30388.98,],
    'Ida' => [2804, 730, 199, 6, 267, 21082.40,],
    'Iowa' => [23136, 2711.65, 6420, 9, 12531, 78312.45,],
    'Jackson' => [7559, 6977.5, 817, 40, 574, 201510.20,],
    'Jasper' => [9567, 11147.66, 779, 26, 1213, 321944.42,],
    'Jefferson' => [5851, 3845, 942, 28, 403, 111043.60,],
    'Johnson' => [15809, 9591.35, 1933, 36, 5575, 276998.19,],
    'Jones' => [6784, 3954.2, 637, 3, 780, 114197.30,],
    'Keokuk' => [7958, 1837.55, 579, 12, 251, 53068.44,],
    'Kossuth' => [5414, 1217.4, 740, 23, 426, 35158.51,],
    'Lee' => [9662, 75.67, 960, 49, 1068, 2185.35,],
    'Linn' => [25421, 16194.71, 4791, 58, 7273, 467703.22,],
    'Louisa' => [5006, 691.95, 1591, 20, 412, 19983.52,],
    'Lucas' => [3009, 1197, 430, 44, 274, 34569.36,],
    'Lyon' => [7424, 675.5, 768, 21, 559, 19508.44,],
    'Madison' => [6405, 2893, 1134, 30, 585, 83549.84,],
    'Mahaska' => [7414, 2792, 551, 27, 614, 80632.96,],
    'Marion' => [7950, 1641.15, 972, 22, 1069, 47396.41,],
    'Marshall' => [6634, 1139.35, 1191, 27, 1130, 32904.43,],
    'Mills' => [4991, 1725.65, 1836, 26, 300, 49836.77,],
    'Mitchell' => [6354, 944.5, 569, 20, 395, 27277.16,],
    'Monona' => [3682, 894.5, 1324, 11, 146, 25833.16,],
    'Monroe' => [4116, 1480.5, 399, 31, 86, 42756.84,],
    'Montgomery' => [3491, 504, 419, 23, 424, 14555.52,],
    'Muscatine' => [6194, 1840, 937, 38, 1176, 53139.20,],
    'O\'Brien' => [6041, 1290.75, 1257, 42, 616, 37276.86,],
    'Osceola' => [2899, 957, 396, 22, 294, 27638.16,],
    'Page' => [6994, 1868, 1063, 14, 743, 53947.84,],
    'Palo Alto' => [5711, 551.5, 367, 39, 292, 15927.32,],
    'Plymouth' => [9761, 5728.25, 782, 13, 917, 165431.86,],
    'Pocahontas' => [3097, 647, 393, 23, 200, 18685.36,],
    'Polk' => [52854, 16851.15, 3034, 111, 18242, 486661.21,],
    'Poweshiek' => [4714, 1101.15, 323, 13, 736, 31801.21,],
    'Ringgold' => [2235, 245, 204, 18, 202, 7075.60,],
    'Sac' => [5364, 929.05, 401, 8, 336, 26830.96,],
    'Scott' => [12327, 4930.95, 1559, 22, 4309, 142405.84,],
    'Shelby' => [4796, 1320.2, 664, 27, 469, 38127.38,],
    'Sioux' => [9088, 865.56, 963, 47, 1172, 24997.37,],
    'Story' => [19817, 11060.4, 3052, 73, 2961, 319424.35,],
    'Tama' => [7638, 1877.75, 2105, 55, 679, 54229.42,],
    'Taylor' => [2180, 70, 116, 13, 226, 2021.60,],
    'Union' => [4035, 702.5, 628, 5, 493, 20288.20,],
    'Van Buren' => [2355, 2200, 314, 26, 151, 63536.00,],
    'Wapello' => [8975, 1899.25, 544, 19, 822, 54850.34,],
    'Warren' => [12081, 5244.77, 1185, 15, 2062, 151468.96,],
    'Washington' => [18188, 7939.75, 2874, 36, 747, 229299.98,],
    'Wayne' => [2345, 824, 855, 14, 120, 23797.12,],
    'Webster' => [6825, 1797.05, 603, 22, 1074, 51898.80,],
    'West Pottawattamie' => [12790, 2684.25, 397, 32, 1549, 77521.14,],
    'Winnebago' => [3142, 496.5, 492, 53, 327, 14338.92,],
    'Winneshiek' => [13045, 2831.95, 1405, 87, 737, 81786.72,],
    'Woodbury' => [17431, 4122.4, 5232, 64, 3319, 119054.91,],
    'Worth' => [3466, 5, 425, 4, 171, 144.40,],
    'Wright' => [3685, 834, 526, 8, 366, 24085.92,],
  ];
}

/**
 * Implements hook_form_alter().
 */

function county_impact_report_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id)
{
  if ($form_id == 'node_county_impact_report_edit_form') {

    $form['actions']['save_review'] = array(
      '#type' => 'submit',
      '#value' => 'Save & Submit for Review',
      '#name' => 'op',
      //'#submit' => ['county_impact_report_form_submit'], /* NEED this */
      '#submit' => array_merge(
        $form['actions']['submit']['#submit'],
        ['county_impact_report_form_submit']
      ),
      '#weight' => 10
    );
  }
}

/*
 * Read the county's data from the data file
 */
function county_impact_report_find_county_impacts() {
  $impacts = [];

  $node = \Drupal::routeMatch()->getParameter('node');
  if ($node instanceof \Drupal\node\NodeInterface) {
    // We have the node, now initiate some more variables
    $title = $node->getTitle();
    $year = intval($title);
    $filename = getcwd() . '/' . \Drupal::service('extension.list.module')->getPath('county_impact_report') . '/assets/' . $year . '_impact_data.csv';
    $countyName = str_replace(' County', '', \Drupal::config('system.site')->get('name'));

    $handle = fopen($filename, 'r');
    while (($row = fgetcsv($handle)) !== FALSE) {
      // Get the header row, should start with 'County'
      if ($row[0] == 'County') {
        $impacts[] = $row;
      }

      // Get the county data
      if ($row[0] == $countyName) {
        $impacts[] = $row;
        break;
      }
    }
    fclose($handle);
  }
  return $impacts;
}

/*
 * Get the icon code for different lables
 */
function county_impact_report_find_icon(string $label) {
  $icon = 'not found';
  $label = str_replace('<br>', ' ', $label);
  $label = str_replace(' ', ' ', $label);
  $label = trim($label);
  $label = strtolower($label);

  switch ($label) {
    case 'educational exchanges with iowans':
      $icon = '<svg class="svg-inline--fa fa-id-card fa-4x" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="id-card" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M0 96l576 0c0-35.3-28.7-64-64-64H64C28.7 32 0 60.7 0 96zm0 32V416c0 35.3 28.7 64 64 64H512c35.3 0 64-28.7 64-64V128H0zM64 405.3c0-29.5 23.9-53.3 53.3-53.3H234.7c29.5 0 53.3 23.9 53.3 53.3c0 5.9-4.8 10.7-10.7 10.7H74.7c-5.9 0-10.7-4.8-10.7-10.7zM176 320c-35.3 0-64-28.7-64-64s28.7-64 64-64s64 28.7 64 64s-28.7 64-64 64zM352 208c0-8.8 7.2-16 16-16H496c8.8 0 16 7.2 16 16s-7.2 16-16 16H368c-8.8 0-16-7.2-16-16zm0 64c0-8.8 7.2-16 16-16H496c8.8 0 16 7.2 16 16s-7.2 16-16 16H368c-8.8 0-16-7.2-16-16zm0 64c0-8.8 7.2-16 16-16H496c8.8 0 16 7.2 16 16s-7.2 16-16 16H368c-8.8 0-16-7.2-16-16z"></path></svg>';
      break;
    case 'ceus or professional certifications received':
      $icon = '<svg class="svg-inline--fa fa-graduation-cap fa-4x" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="graduation-cap" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" data-fa-i2svg=""><path fill="currentColor" d="M320 32c-8.1 0-16.1 1.4-23.7 4.1L15.8 137.4C6.3 140.9 0 149.9 0 160s6.3 19.1 15.8 22.6l57.9 20.9C57.3 229.3 48 259.8 48 291.9v28.1c0 28.4-10.8 57.7-22.3 80.8c-6.5 13-13.9 25.8-22.5 37.6C0 442.7-.9 448.3 .9 453.4s6 8.9 11.2 10.2l64 16c4.2 1.1 8.7 .3 12.4-2s6.3-6.1 7.1-10.4c8.6-42.8 4.3-81.2-2.1-108.7C90.3 344.3 86 329.8 80 316.5V291.9c0-30.2 10.2-58.7 27.9-81.5c12.9-15.5 29.6-28 49.2-35.7l157-61.7c8.2-3.2 17.5 .8 20.7 9s-.8 17.5-9 20.7l-157 61.7c-12.4 4.9-23.3 12.4-32.2 21.6l159.6 57.6c7.6 2.7 15.6 4.1 23.7 4.1s16.1-1.4 23.7-4.1L624.2 182.6c9.5-3.4 15.8-12.5 15.8-22.6s-6.3-19.1-15.8-22.6L343.7 36.1C336.1 33.4 328.1 32 320 32zM128 408c0 35.3 86 72 192 72s192-36.7 192-72L496.7 262.6 354.5 314c-11.1 4-22.8 6-34.5 6s-23.5-2-34.5-6L143.3 262.6 128 408z"></path></svg>';
      break;
    case 'local partners':
      $icon = '<svg class="svg-inline--fa fa-handshake-simple fa-4x" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="handshake-simple" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" data-fa-i2svg=""><path fill="currentColor" d="M323.4 85.2l-96.8 78.4c-16.1 13-19.2 36.4-7 53.1c12.9 17.8 38 21.3 55.3 7.8l99.3-77.2c7-5.4 17-4.2 22.5 2.8s4.2 17-2.8 22.5l-20.9 16.2L550.2 352H592c26.5 0 48-21.5 48-48V176c0-26.5-21.5-48-48-48H516h-4-.7l-3.9-2.5L434.8 79c-15.3-9.8-33.2-15-51.4-15c-21.8 0-43 7.5-60 21.2zm22.8 124.4l-51.7 40.2C263 274.4 217.3 268 193.7 235.6c-22.2-30.5-16.6-73.1 12.7-96.8l83.2-67.3c-11.6-4.9-24.1-7.4-36.8-7.4C234 64 215.7 69.6 200 80l-72 48H48c-26.5 0-48 21.5-48 48V304c0 26.5 21.5 48 48 48H156.2l91.4 83.4c19.6 17.9 49.9 16.5 67.8-3.1c5.5-6.1 9.2-13.2 11.1-20.6l17 15.6c19.5 17.9 49.9 16.6 67.8-2.9c4.5-4.9 7.8-10.6 9.9-16.5c19.4 13 45.8 10.3 62.1-7.5c17.9-19.5 16.6-49.9-2.9-67.8l-134.2-123z"></path></svg>';
      break;
    case 'youth reached':
      $icon = '<img loading="lazy" src="https://photos.smugmug.com/WORDMARKS/Primary-4-HExtension/CloverEmblem/White/High-Res/i-kxnLLqT/0/MZxc3sZwVCcfLC829w2Sv8R4C2N9zbbcqhRVRF8L7/D/Clover_Wht-D.png" alt="4-H clover emblem" style="height:4.5rem">';
      break;
    case 'volunteer hours':
      $icon = '<svg class="svg-inline--fa fa-person-circle-question fa-4x" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="person-circle-question" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M208 48c0 26.5-21.5 48-48 48s-48-21.5-48-48s21.5-48 48-48s48 21.5 48 48zM152 352V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V256.9L59.4 304.5c-9.1 15.1-28.8 20-43.9 10.9s-20-28.8-10.9-43.9l58.3-97c17.4-28.9 48.6-46.6 82.3-46.6h29.7c33.7 0 64.9 17.7 82.3 46.6l44.9 74.7c-16.1 17.6-28.6 38.5-36.6 61.5c-1.9-1.8-3.5-3.9-4.9-6.3L232 256.9V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V352H152zM432 512c-79.5 0-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144s-64.5 144-144 144zm0-48c13.3 0 24-10.7 24-24s-10.7-24-24-24s-24 10.7-24 24s10.7 24 24 24zM368 321.6V328c0 8.8 7.2 16 16 16s16-7.2 16-16v-6.4c0-5.3 4.3-9.6 9.6-9.6h40.5c7.7 0 13.9 6.2 13.9 13.9c0 5.2-2.9 9.9-7.4 12.3l-32 16.8c-5.3 2.8-8.6 8.2-8.6 14.2V384c0 8.8 7.2 16 16 16s16-7.2 16-16v-5.1l23.5-12.3c15.1-7.9 24.5-23.6 24.5-40.6c0-25.4-20.6-45.9-45.9-45.9H409.6c-23 0-41.6 18.6-41.6 41.6z"></path></svg>';
      break;
    case 'value of volunteer time':
      $icon = '<svg class="svg-inline--fa fa-clock fa-4x" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="clock" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M256 512C114.6 512 0 397.4 0 256S114.6 0 256 0S512 114.6 512 256s-114.6 256-256 256zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"></path></svg>';
      break;
  }
  return $icon;
}

function county_impact_report_format_value($value, $label) {
  $label = trim(strtolower($label));
  $value = number_format($value);
  if (str_starts_with($label, 'value')) {
    $value = '$' . $value;
  }
  return $value;
}
