<?php

/*
 * Implements hook_ENTITY_TYPE_update()
 */

use Drupal\contact\Entity\Message;
use Drupal\Core\Form\FormStateInterface;
use Drupal\file\Entity\File;
use Drupal\media\Entity\Media;
use Drupal\paragraphs\Entity\Paragraph;

/**
 * Implements hook_entity_presave().
 */

function county_impact_report_node_presave(Drupal\Core\Entity\EntityInterface $entity)
{
  $userId = \Drupal::currentUser()->id();
  if ($entity->getType() == 'county_impact_report') {
    $entity->setOwnerId($userId);
  }
}

/*
 * Not sure this function ever gets called
 */
function county_impact_report_content_update(Drupal\Core\Entity\EntityInterface $entity)
{
  // Clear cache if BlockContent is of type
  if ($entity->bundle() == 'county_impact_remport') {
    \Drupal::service('cache.render')->invalidateAll();
  }
}

function county_impact_report_theme_suggestions_block_alter(&$suggestions, $variables)
{
  $content = $variables['elements']['content'];
  if (isset($content['#block_content']) && $content['#block_content'] instanceof \Drupal\block_content\BlockContentInterface) {
    $suggestions[] = 'block__' . $content['#block_content']->bundle();
  }
}

function county_impact_report_preprocess_block(&$variables)
{
  if ($variables['plugin_id'] == 'extra_field_block:node:county_impact_report:links') {
    $variables['#attached']['library'][] = 'county_impact_report/county_impact_report';
  }
}

/**
 * Implements hook_theme().
 */
function county_impact_report_theme($existing, $type, $theme, $path)
{
  return [
    'paragraph__county_impact_story' => [
      'variables' => [
        'top_impact_data' => [],
      ],
      'template' => 'paragraph--county-impact-story',
      'base hook' => 'paragraph',
    ],
    'page__type__county_impact_report__canonical' => [
      'variables' => [
        'bottom_impact_data' => [],
        'first_paragraph_id' => 0,
        'last_paragraph_id' => 0,
      ],
      'template' => 'page--type--county-impact-report--canonical',
      'base hook' => 'node',
    ],
  ];
}

/**
 * Implements hook_preprocess_HOOK().
 */

function county_impact_report_preprocess_paragraph__county_impact_story(&$variables)
{
  // Get the impact data
  $impactData = county_impact_report_find_county_impacts();
  $impacts = [];
  $impacts[0]['label'] = $impactData[0][1];
  $impacts[0]['icon'] = county_impact_report_find_icon($impactData[0][1]);
  $impacts[0]['value'] = county_impact_report_format_value($impactData[1][1], $impactData[0][1]);
  $impacts[1]['label'] = $impactData[0][5];
  $impacts[1]['icon'] = county_impact_report_find_icon($impactData[0][5]);
  $impacts[1]['value'] = county_impact_report_format_value($impactData[1][5], $impactData[0][5]);
  $impacts[2]['label'] = $impactData[0][4];
  $impacts[2]['icon'] = county_impact_report_find_icon($impactData[0][4]);
  $impacts[2]['value'] = county_impact_report_format_value($impactData[1][4], $impactData[0][4]);
  $variables['top_impact_data'] = $impacts;

  // Get the first and last id of the paragraphs on the page
  $variables['first_paragraph_id'] = 0;
  $variables['last_paragraph_id'] = 0;
  $node = \Drupal::routeMatch()->getParameter('node');
  if ($node instanceof \Drupal\node\NodeInterface) {
    $paragraphs = $node->get('field_impact_story')->getValue();
    foreach ($paragraphs as $paragraph) {
      if ($variables['first_paragraph_id'] == 0) {
        $variables['first_paragraph_id'] = $paragraph['target_id'];
      }
      $variables['last_paragraph_id'] = $paragraph['target_id'];
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */

function county_impact_report_preprocess_page__type__county_impact_report__canonical(&$variables)
{
  // Get the impact data
  $impactData = county_impact_report_find_county_impacts();
  $impacts = [];
  $impacts[0]['label'] = $impactData[0][3];
  $impacts[0]['icon'] = county_impact_report_find_icon($impactData[0][3]);
  $impacts[0]['value'] = county_impact_report_format_value($impactData[1][3], $impactData[0][3]);
  $impacts[1]['label'] = $impactData[0][2];
  $impacts[1]['icon'] = county_impact_report_find_icon($impactData[0][2]);
  $impacts[1]['value'] = county_impact_report_format_value($impactData[1][2], $impactData[0][2]);
  $impacts[2]['label'] = $impactData[0][6];
  $impacts[2]['icon'] = county_impact_report_find_icon($impactData[0][6]);
  $impacts[2]['value'] = county_impact_report_format_value($impactData[1][6], $impactData[0][6]);
  $variables['bottom_impact_data'] = $impacts;
}

/**
 * Implements hook_form_alter().
 */

function county_impact_report_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id)
{
  if ($form_id == 'node_county_impact_report_edit_form') {

    $form['actions']['save_review'] = array(
      '#type' => 'submit',
      '#value' => 'Save & Submit for Review',
      '#name' => 'op',
      //'#submit' => ['county_impact_report_form_submit'], /* NEED this */
      '#submit' => array_merge(
        $form['actions']['submit']['#submit'],
        ['county_impact_report_form_submit']
      ),
      '#weight' => 10
    );
  }
}

/*
 * Read the county's data from the data file
 */
function county_impact_report_find_county_impacts() {
  $impacts = [];

  $node = \Drupal::routeMatch()->getParameter('node');
  if ($node instanceof \Drupal\node\NodeInterface) {
    // We have the node, now initiate some more variables
    $title = $node->getTitle();
    $year = intval($title);
    $filename = getcwd() . '/' . \Drupal::service('extension.list.module')->getPath('county_impact_report') . '/assets/' . $year . '_impact_data.csv';
    $countyName = str_replace(' County', '', \Drupal::config('system.site')->get('name'));

    $handle = fopen($filename, 'r');
    while (($row = fgetcsv($handle)) !== FALSE) {
      // Get the header row, should start with 'County'
      if ($row[0] == 'County') {
        $impacts[] = $row;
      }

      // Get the county data
      if ($row[0] == $countyName) {
        $impacts[] = $row;
        break;
      }
    }
    fclose($handle);
  }
  return $impacts;
}

/*
 * Get the icon code for different lables
 */
function county_impact_report_find_icon($label) {
  $icon = 'not found';
  $label = str_replace('<br>', ' ', $label);
  $label = str_replace(' ', ' ', $label);
  $label = trim($label);
  $label = strtolower($label);

  switch ($label) {
    case 'educational exchanges with iowans':
      $icon = '<svg class="svg-inline--fa fa-id-card fa-4x" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="id-card" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M0 96l576 0c0-35.3-28.7-64-64-64H64C28.7 32 0 60.7 0 96zm0 32V416c0 35.3 28.7 64 64 64H512c35.3 0 64-28.7 64-64V128H0zM64 405.3c0-29.5 23.9-53.3 53.3-53.3H234.7c29.5 0 53.3 23.9 53.3 53.3c0 5.9-4.8 10.7-10.7 10.7H74.7c-5.9 0-10.7-4.8-10.7-10.7zM176 320c-35.3 0-64-28.7-64-64s28.7-64 64-64s64 28.7 64 64s-28.7 64-64 64zM352 208c0-8.8 7.2-16 16-16H496c8.8 0 16 7.2 16 16s-7.2 16-16 16H368c-8.8 0-16-7.2-16-16zm0 64c0-8.8 7.2-16 16-16H496c8.8 0 16 7.2 16 16s-7.2 16-16 16H368c-8.8 0-16-7.2-16-16zm0 64c0-8.8 7.2-16 16-16H496c8.8 0 16 7.2 16 16s-7.2 16-16 16H368c-8.8 0-16-7.2-16-16z"></path></svg>';
      break;
    case 'ceus or professional certifications received':
      $icon = '<svg class="svg-inline--fa fa-graduation-cap fa-4x" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="graduation-cap" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" data-fa-i2svg=""><path fill="currentColor" d="M320 32c-8.1 0-16.1 1.4-23.7 4.1L15.8 137.4C6.3 140.9 0 149.9 0 160s6.3 19.1 15.8 22.6l57.9 20.9C57.3 229.3 48 259.8 48 291.9v28.1c0 28.4-10.8 57.7-22.3 80.8c-6.5 13-13.9 25.8-22.5 37.6C0 442.7-.9 448.3 .9 453.4s6 8.9 11.2 10.2l64 16c4.2 1.1 8.7 .3 12.4-2s6.3-6.1 7.1-10.4c8.6-42.8 4.3-81.2-2.1-108.7C90.3 344.3 86 329.8 80 316.5V291.9c0-30.2 10.2-58.7 27.9-81.5c12.9-15.5 29.6-28 49.2-35.7l157-61.7c8.2-3.2 17.5 .8 20.7 9s-.8 17.5-9 20.7l-157 61.7c-12.4 4.9-23.3 12.4-32.2 21.6l159.6 57.6c7.6 2.7 15.6 4.1 23.7 4.1s16.1-1.4 23.7-4.1L624.2 182.6c9.5-3.4 15.8-12.5 15.8-22.6s-6.3-19.1-15.8-22.6L343.7 36.1C336.1 33.4 328.1 32 320 32zM128 408c0 35.3 86 72 192 72s192-36.7 192-72L496.7 262.6 354.5 314c-11.1 4-22.8 6-34.5 6s-23.5-2-34.5-6L143.3 262.6 128 408z"></path></svg>';
      break;
    case 'local partners':
      $icon = '<svg class="svg-inline--fa fa-handshake-simple fa-4x" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="handshake-simple" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" data-fa-i2svg=""><path fill="currentColor" d="M323.4 85.2l-96.8 78.4c-16.1 13-19.2 36.4-7 53.1c12.9 17.8 38 21.3 55.3 7.8l99.3-77.2c7-5.4 17-4.2 22.5 2.8s4.2 17-2.8 22.5l-20.9 16.2L550.2 352H592c26.5 0 48-21.5 48-48V176c0-26.5-21.5-48-48-48H516h-4-.7l-3.9-2.5L434.8 79c-15.3-9.8-33.2-15-51.4-15c-21.8 0-43 7.5-60 21.2zm22.8 124.4l-51.7 40.2C263 274.4 217.3 268 193.7 235.6c-22.2-30.5-16.6-73.1 12.7-96.8l83.2-67.3c-11.6-4.9-24.1-7.4-36.8-7.4C234 64 215.7 69.6 200 80l-72 48H48c-26.5 0-48 21.5-48 48V304c0 26.5 21.5 48 48 48H156.2l91.4 83.4c19.6 17.9 49.9 16.5 67.8-3.1c5.5-6.1 9.2-13.2 11.1-20.6l17 15.6c19.5 17.9 49.9 16.6 67.8-2.9c4.5-4.9 7.8-10.6 9.9-16.5c19.4 13 45.8 10.3 62.1-7.5c17.9-19.5 16.6-49.9-2.9-67.8l-134.2-123z"></path></svg>';
      break;
    case 'youth reached':
      $icon = '<img loading="lazy" src="https://photos.smugmug.com/WORDMARKS/Primary-4-HExtension/CloverEmblem/White/High-Res/i-kxnLLqT/0/MZxc3sZwVCcfLC829w2Sv8R4C2N9zbbcqhRVRF8L7/D/Clover_Wht-D.png" alt="4-H clover emblem" style="height:4.5rem">';
      break;
    case 'volunteer hours':
      $icon = '<svg class="svg-inline--fa fa-person-circle-question fa-4x" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="person-circle-question" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M208 48c0 26.5-21.5 48-48 48s-48-21.5-48-48s21.5-48 48-48s48 21.5 48 48zM152 352V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V256.9L59.4 304.5c-9.1 15.1-28.8 20-43.9 10.9s-20-28.8-10.9-43.9l58.3-97c17.4-28.9 48.6-46.6 82.3-46.6h29.7c33.7 0 64.9 17.7 82.3 46.6l44.9 74.7c-16.1 17.6-28.6 38.5-36.6 61.5c-1.9-1.8-3.5-3.9-4.9-6.3L232 256.9V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V352H152zM432 512c-79.5 0-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144s-64.5 144-144 144zm0-48c13.3 0 24-10.7 24-24s-10.7-24-24-24s-24 10.7-24 24s10.7 24 24 24zM368 321.6V328c0 8.8 7.2 16 16 16s16-7.2 16-16v-6.4c0-5.3 4.3-9.6 9.6-9.6h40.5c7.7 0 13.9 6.2 13.9 13.9c0 5.2-2.9 9.9-7.4 12.3l-32 16.8c-5.3 2.8-8.6 8.2-8.6 14.2V384c0 8.8 7.2 16 16 16s16-7.2 16-16v-5.1l23.5-12.3c15.1-7.9 24.5-23.6 24.5-40.6c0-25.4-20.6-45.9-45.9-45.9H409.6c-23 0-41.6 18.6-41.6 41.6z"></path></svg>';
      break;
    case 'value of volunteer time':
      $icon = '<svg class="svg-inline--fa fa-clock fa-4x" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="clock" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M256 512C114.6 512 0 397.4 0 256S114.6 0 256 0S512 114.6 512 256s-114.6 256-256 256zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"></path></svg>';
      break;
  }
  return $icon;
}

function county_impact_report_format_value($value, $label) {
  $label = trim(strtolower($label));
  $value = number_format($value);
  if (str_starts_with($label, 'value')) {
    $value = '$' . $value;
  }
  return $value;
}

/**
 * Implements hook_field_widget_single_element_form_alter().
 */

function county_impact_report_field_widget_single_element_form_alter(array &$element, FormStateInterface $form_state, array $context)
{
  if (isset($element['#paragraph_type']) && $element['#paragraph_type'] === 'data_points_selector') {
    $impactData = county_impact_report_find_county_impacts();
    for ($i = 1; $i < 11; $i = $i + 1) {
      if (array_key_exists($i, $impactData[0])) {
        $element['subform']['field_data_point_1']['widget']['#options'][$i] = str_replace('<br>', ' ', $impactData[0][$i]) . ' (' . county_impact_report_format_value($impactData[1][$i], $impactData[0][$i]) . ')';
        $element['subform']['field_data_point_2']['widget']['#options'][$i] = str_replace('<br>', ' ', $impactData[0][$i]) . ' (' . county_impact_report_format_value($impactData[1][$i], $impactData[0][$i]) . ')';
        $element['subform']['field_data_point_3']['widget']['#options'][$i] = str_replace('<br>', ' ', $impactData[0][$i]) . ' (' . county_impact_report_format_value($impactData[1][$i], $impactData[0][$i]) . ')';
      } else {
        unset($element['subform']['field_data_point_1']['widget']['#options'][$i]);
        unset($element['subform']['field_data_point_2']['widget']['#options'][$i]);
        unset($element['subform']['field_data_point_3']['widget']['#options'][$i]);
      }
    }
  }
}
