<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\block\BlockForm;
use Drupal\block_content\BlockContentInterface;
use Drupal\block\BlockPluginInterface;
use Drupal\isueo_helpers\ISUEOHelpers;

/**
* Implements hook_preprocess_HOOK().
* DELETE ME!
*/
function products_preprocess_node(&$variables) {
  // Delete Me for production
  // Clear's the twig cache, so we don't have to keep doing drush cr
  \Drupal::service('twig')->invalidate();
}

/**
 * Implements hook_theme().
 */

function products_theme($existing, $type, $theme, $path)
{

  return [
    'paragraph__product' => [
      'template' => 'paragraph--product',
      'base hook' => 'paragraph',
    ]
  ];
}

/**
 * Implements hook_form_alter().
 */

/*
function products_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  if ($form_id == 'layout_builder_update_block' || $form_id == 'layout_builder_add_block') {
  }
}
*/

/*
function products_block_type_form_alter(array &$form, FormStateInterface &$form_state, string $block_type) {
  Drupal::logger('blah')->info($block_type);
  if ($block_type == 'accordion') {
    $form['example_field']['widget'][0]['value']['#default_value'] = 'A better default value';
  }
}
*/

/**
 * Implements hook_entity_presave().
 */

function products_entity_presave(Drupal\Core\Entity\EntityInterface $entity)
{
  if ($entity->getEntityTypeId() == 'paragraph') {
    if ($entity->bundle() == 'product') {
      $found = false;
      $raw = ISUEOHelpers\Files::fetch_url('https://datastore.exnet.iastate.edu/mydata/Store/FullProduct.json', false);
      $products = json_decode($raw, true);
      $sku = strtolower(trim($entity->get('field_product_sku')->getString()));

      foreach ($products as $product) {
        if ($sku == $product['ProductID']) {
          $found = true;
          $entity->set('field_product_sku', $sku);
          $entity->set('field_product_title', $product['Title']);
          $entity->set('field_product_image', $product['ThumbnailURI']);
          $entity->set('field_product_date', $product['PubDate']);
          break;
        }
        if (!$found) {
          $entity->set('field_product_sku', $sku);
          $entity->set('field_product_title', 'Not Found');
          $entity->set('field_product_image', '');
          $entity->set('field_product_date', '');
        }
      }
    }
  }
}
