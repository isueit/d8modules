{#
/**
 * @file
 * Generic newsletter export template - all-in-one with proper image sizing.
 */
#}
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ node.label }}</title>
  <style>
    img { max-width: 100%; height: auto; display: block; }
    body, table, td { font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; }
    /* Force images to respect dimensions in email clients */
    img[width] { width: auto !important; max-width: 100% !important; }
  </style>
</head>
<body>
<center>
  <table align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
    <tr>
      <td align="center" valign="top">

        {# Get hero background image #}
        {% set hero_image_url = '' %}
        {% if node.field_newsletter_hero is not empty %}
          {% set hero_paragraph = node.field_newsletter_hero.0.entity %}
          {% if hero_paragraph %}
            {% if hero_paragraph.field_newsletter_featured_image is not empty %}
              {% set image_value = hero_paragraph.field_newsletter_featured_image.value %}
              {% if image_value %}
                {% set module_path = 'modules/custom/d8modules/news_article/newsletter' %}
                {% set base_url_clean = url('<front>')|render|trim('/') %}
                {% set hero_image_url = base_url_clean ~ '/' ~ module_path ~ '/images/' ~ image_value ~ '.png' %}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endif %}

        {# Check if this is a 4-H or Clover Kids newsletter to show clover logo #}
        {% set show_clover_logo = false %}
        {% if node.field_newsletter_type is not empty %}
          {% for term_item in node.field_newsletter_type %}
            {% if term_item.entity %}
              {% set term_name = term_item.entity.name.value|lower %}
              {% if '4-h' in term_name or 'clover kids' in term_name %}
                {% set show_clover_logo = true %}
              {% endif %}
            {% endif %}
          {% endfor %}
        {% endif %}

        <!-- HEADER WITH BACKGROUND IMAGE -->
        <table border="0" cellpadding="0" cellspacing="0" width="600">
          <tr>
            <td align="center" valign="top" style="padding:0;">
              {% if hero_image_url %}
                {# Full-width background image with overlay #}
                <table border="0" cellpadding="0" cellspacing="0" width="600" style="background-image: url('{{ hero_image_url }}'); background-size: cover; background-position: center; background-repeat: no-repeat;">
                  <tr>
                    <td style="padding: 40px 20px; background-color: rgba(0, 0, 0, 0.5);">
                      <table border="0" cellpadding="0" cellspacing="0" width="100%">
                        <tr>
                          {% if show_clover_logo %}
                          <td valign="middle" style="width: 75px;">
                            {# Clover logo - 60px for 4-H/Clover Kids newsletters only #}
                            <img src="https://photos.smugmug.com/WORDMARKS/Primary-4-HExtension/CloverEmblem/White/High-Res/i-kxnLLqT/0/MZxc3sZwVCcfLC829w2Sv8R4C2N9zbbcqhRVRF8L7/D/Clover_Wht-D.png" 
                                 alt="4-H Clover" 
                                 width="60" 
                                 height="60" 
                                 style="width: 60px; height: 60px; max-width: 60px; display: inline-block; vertical-align: middle; margin-right: 15px;">
                          </td>
                          {% endif %}
                          <td valign="middle" style="text-align: left;">
                            {# Title and issue info #}
                            <h1 style="color: #ffffff; font-size: 28px; font-weight: bold; line-height: 1.2; margin: 0 0 5px 0;">
                              {{ node.label }}
                            </h1>
                            {% if node.field_newsletter_issue_date.value or node.field_newsletter_issue_number.value %}
                              <p style="color: #ffffff; font-size: 16px; margin: 0; line-height: 1.4;">
                                {% if node.field_newsletter_issue_date.value and node.field_newsletter_issue_number.value %}
                                  {{ node.field_newsletter_issue_date.value }}, {{ node.field_newsletter_issue_number.value }}
                                {% elseif node.field_newsletter_issue_date.value %}
                                  {{ node.field_newsletter_issue_date.value }}
                                {% else %}
                                  {{ node.field_newsletter_issue_number.value }}
                                {% endif %}
                              </p>
                            {% endif %}
                          </td>
                        </tr>
                      </table>
                    </td>
                  </tr>
                </table>
              {% else %}
                {# Fallback without hero image #}
                <table border="0" cellpadding="0" cellspacing="0" width="600">
                  <tr>
                    <td style="padding: 20px;">
                      <h1 style="color: #202020; font-size: 28px; font-weight: bold; margin: 0;">{{ node.label }}</h1>
                      {% if node.field_newsletter_issue_date.value or node.field_newsletter_issue_number.value %}
                        <p style="color: #666666; font-size: 16px; margin: 10px 0 0 0;">
                          {% if node.field_newsletter_issue_date.value and node.field_newsletter_issue_number.value %}
                            {{ node.field_newsletter_issue_date.value }}, {{ node.field_newsletter_issue_number.value }}
                          {% elseif node.field_newsletter_issue_date.value %}
                            {{ node.field_newsletter_issue_date.value }}
                          {% else %}
                            {{ node.field_newsletter_issue_number.value }}
                          {% endif %}
                        </p>
                      {% endif %}
                    </td>
                  </tr>
                </table>
              {% endif %}
            </td>
          </tr>
        </table>

        <!-- MAIN CONTENT + SIDEBAR -->
        <table border="0" cellpadding="0" cellspacing="0" width="600">
          <tr>
            <!-- Main Content Column -->
            <td valign="top" width="390" style="padding: 20px 18px;">
              
              {# Loop through content paragraphs if field exists #}
              {% if node.field_newsletter_content is not empty %}
                {% for item in node.field_newsletter_content %}
                  {% if item.entity %}
                    {% set para = item.entity %}
                    {% set para_type = para.getType() %}
                    
                    {# SECTION HEADING with background image and small clover #}
                    {% if para_type == 'section_heading' %}
                      {% if para.field_section_heading is not empty %}
                        {% set heading_text = para.field_section_heading.value %}
                        {% set heading_slug = heading_text|lower|replace({' ': '-'}) %}
                        {% set heading_id = heading_slug ~ '-' ~ para.id() %}
                        
                        <table border="0" cellpadding="0" cellspacing="0" width="100%" id="{{ heading_id }}" style="margin: 30px 0 20px 0; {% if hero_image_url %}background-image: url('{{ hero_image_url }}'); background-size: cover; background-position: center;{% else %}background-color: #c8102e;{% endif %}">
                          <tr>
                            <td style="padding: 20px 15px; {% if hero_image_url %}background-color: rgba(200, 16, 46, 0.85);{% endif %}">
                              <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                  {% if show_clover_logo %}
                                  <td valign="middle" style="width: 54px;">
                                    {# Small clover for section headings - 42px (2.6rem) - only for 4-H/Clover Kids #}
                                    <img src="https://photos.smugmug.com/WORDMARKS/Primary-4-HExtension/CloverEmblem/White/High-Res/i-kxnLLqT/0/MZxc3sZwVCcfLC829w2Sv8R4C2N9zbbcqhRVRF8L7/D/Clover_Wht-D.png" 
                                         alt="" 
                                         width="42" 
                                         height="42" 
                                         style="width: 42px; height: 42px; max-width: 42px; display: block; margin-right: 12px;">
                                  </td>
                                  {% endif %}
                                  <td valign="middle">
                                    <h2 style="color: #ffffff; font-size: 22px; font-weight: bold; margin: 0; line-height: 1.3;">
                                      {{ heading_text }}
                                    </h2>
                                  </td>
                                </tr>
                              </table>
                            </td>
                          </tr>
                        </table>
                      {% endif %}
                    
                    {# OTHER PARAGRAPH TYPES - render normally #}
                    {% else %}
                      {{ content.field_newsletter_content[loop.index0] }}
                    {% endif %}
                    
                  {% endif %}
                {% endfor %}
              {% endif %}
              
            </td>
            
            <!-- Save the Date Sidebar -->
            <td valign="top" width="210" style="padding: 20px 18px; background-color: #f9f9f9; border-left: 1px solid #dddddd;">
              <h4 style="color: #c8102e; font-size: 18px; font-weight: bold; margin: 0 0 10px 0;">Important Dates</h4>
              <hr style="border: 0; border-top: 2px solid #c8102e; margin: 0 0 15px 0;">
              
              {% if node.field_newsletter_save_the_date is not empty %}
                {% for item in node.field_newsletter_save_the_date %}
                  {% if item.entity %}
                    {% set event = item.entity %}
                    
                    <table border="0" cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 15px;">
                      <tr>
                        <td valign="top" style="width: 50px; padding-right: 10px;">
                          <table border="0" cellpadding="0" cellspacing="0" width="50" style="background-color: #c8102e; text-align: center;">
                            <tr>
                              <td style="background-color: #c8102e; color: #ffffff; font-size: 11px; font-weight: bold; padding: 4px 2px; text-transform: uppercase;">
                                {% if event.field_newsletter_event_date is not empty %}
                                  {{ event.field_newsletter_event_date.value|date('M') }}
                                {% endif %}
                              </td>
                            </tr>
                            <tr>
                              <td style="background-color: #ffffff; color: #202020; font-size: 20px; font-weight: bold; padding: 8px 2px;">
                                {% if event.field_newsletter_event_date is not empty %}
                                  {{ event.field_newsletter_event_date.value|date('j') }}
                                {% endif %}
                              </td>
                            </tr>
                          </table>
                        </td>
                        <td valign="top">
                          {% if event.field_newsletter_event_title is not empty %}
                            <p style="margin: 0 0 5px 0; font-size: 13px; font-weight: bold;">
                              {{ event.field_newsletter_event_title.value }}
                            </p>
                          {% endif %}
                          
                          {% if event.field_newsletter_event_time is not empty %}
                            <p style="margin: 0 0 3px 0; font-size: 12px; color: #555555;">
                              {{ event.field_newsletter_event_time.value }}
                            </p>
                          {% endif %}
                          
                          {% if event.field_newsletter_event_location is not empty %}
                            <p style="margin: 0; font-size: 12px; color: #555555;">
                              {{ event.field_newsletter_event_location.value }}
                            </p>
                          {% endif %}
                        </td>
                      </tr>
                    </table>
                    
                    {% if not loop.last %}
                      <hr style="border: 0; border-top: 1px solid #dddddd; margin: 0 0 15px 0;">
                    {% endif %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            </td>
          </tr>
        </table>

        <!-- FOOTER -->
        <table border="0" cellpadding="0" cellspacing="0" width="600">
          <tr>
            <td style="padding:18px; color:#656565; font-size:12px; text-align:center;">
              <p style="margin: 0;">This institution is an equal opportunity provider.<br>
              <a href="https://www.extension.iastate.edu/legal" style="color: #006ba6;">www.extension.iastate.edu/legal</a></p>
            </td>
          </tr>
        </table>

      </td>
    </tr>
  </table>
</center>
</body>
</html>