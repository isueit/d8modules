<?php

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\node\Entity\Node;
use Drupal\Core\Form\FormStateInterface;
use Drupal\views\ViewExecutable;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\node\NodeInterface;

/**
 * Implements hook_preprocess_HOOK().
 */

function newsletter_preprocess_node(&$variables)
{
  // Add the css file if we're on content type
  $node = $variables['node'];
  if ($node->getType() == 'newsletter') {
    $variables['#attached']['library'][] = 'newsletter/newsletter';
  }
} 

/**
 * Implements hook_theme().
 */

function newsletter_theme($existing, $type, $theme, $path)
{
  return [
    'paragraph__featured_content' => [
      'template' => 'paragraph--featured-content',
      'base hook' => 'paragraph',
    ],
    'paragraph__create_content' => [
      'template' => 'paragraph--create-content',
      'base hook' => 'paragraph',
    ],

    'field__paragraph__field_section_heading' => [
      'template' => 'field--paragraph--field-section-heading',
      'base hook' => 'field',
    ],

    'page__type__newsletter__canonical' => [
      'template' => 'page--type--newsletter--canonical',
      'base hook' => 'node',
    ],

    'node__newsletter__newsletter_export' => [
      'template' => 'node--newsletter--newsletter-export',
      'base hook' => 'node',
    ],

    'block__field_block__node__newsletter__field_newsletter_save_the_date' => [
      'template' => 'block--field-block--node--newsletter--field-newsletter-save-the-date',
      'base hook' => 'block',
    ],
    'newsletter_export' => [
      'variables' => [
        'html' => NULL,
        'node' => NULL,
      ],
      'template' => 'newsletter-export',
    ],
  ];
}


/**
 * Implements hook_form_alter().
 */
function newsletter_form_alter(&$form, FormStateInterface $form_state, $form_id)
{
  if ($form_id == 'node_newsletter_edit_form' || $form_id == 'node_newsletter_form') {
    if (isset($form['field_newsletter_exclude']['widget']['value'])) {
      // Move to options group
      $form['field_newsletter_exclude']['#group'] = 'options';
      $form['field_newsletter_exclude']['#weight'] = 10;

      // Modify the display but keep the structure intact
      $form['field_newsletter_exclude']['widget']['value']['#type'] = 'checkbox';
      $form['field_newsletter_exclude']['widget']['value']['#title'] = t('Exclude from homepage');

      // Hide the wrapper label since checkbox has its own title
      $form['field_newsletter_exclude']['widget']['#title_display'] = 'invisible';
    }

    if (isset($form['field_newsletter_archive_exclude']['widget']['value'])) {
      // Move to options group
      $form['field_newsletter_archive_exclude']['#group'] = 'options';
      $form['field_newsletter_archive_exclude']['#weight'] = 11;

      // Modify the display but keep the structure intact
      $form['field_newsletter_archive_exclude']['widget']['value']['#type'] = 'checkbox';
      $form['field_newsletter_archive_exclude']['widget']['value']['#title'] = t('Do not auto archive');

      // Hide the wrapper label since checkbox has its own title
      $form['field_newsletter_archive_exclude']['widget']['#title_display'] = 'invisible';
    }
  }
}


/**
 * Implements hook_field_widget_single_element_form_alter().
 */

function newsletter_field_widget_single_element_form_alter(array &$element, FormStateInterface $form_state, array $context)
{
  // Want to alert the featured image paragraph type
  if (isset($element['#paragraph_type']) && $element['#paragraph_type'] === 'featured_image') {
    // Initialize some variables
    $image_files = [];
    $module_path = \Drupal::service('module_handler')->getModule('newsletter')->getPath();
    $images_path = DRUPAL_ROOT . '/' . $module_path . '/images';

    // Build the array of filenames and image urls
    foreach (glob($images_path . '/*.*') as $file) {
      $path_info = pathinfo($file);
      $image_files[$path_info['filename']] = '<img src="' . htmlspecialchars(base_path() . $module_path . '/images/' . $path_info['basename']) . '" ' .
        'alt="' . htmlspecialchars($path_info['filename']) . '" ' .
        'class="module-image-thumbnail" ' .
        'width="300px" ' .
        'height="auto" ' .
        ' />';
    }

    // Replace the $labels in the radio buttons
    foreach ($element['subform']['field_newsletter_featured_image']['widget']['#options'] as $value => $label) {
      if ($value == '_none') {
        $element['subform']['field_newsletter_featured_image']['widget']['#options']['_none'] = 'None';
      } elseif (array_key_exists($value, $image_files)) {
        $element['subform']['field_newsletter_featured_image']['widget']['#options'][$value] = 
          '<span class="featured-image-option">' .
            '<span class="featured-image-label">' . $label . '</span>' .
            '<span class="featured-image-preview">' . $image_files[$value] . '</span>' .
          '</span>';
      }
    }
      $element['subform']['field_newsletter_featured_image']['widget']['#attached']['library'][] = 'newsletter/image_widget';

  }
}
/**
 * Implements hook_preprocess_paragraph().
 */
function newsletter_preprocess_paragraph(&$variables) {
  $paragraph = $variables['paragraph'];
  
  // For section heading paragraphs, add the ID
  if ($paragraph->bundle() == 'section_heading') {
    $heading_text = $paragraph->field_section_heading->value;
    $heading_slug = _newsletter_create_slug($heading_text);
    $heading_id = $heading_slug . '-' . $paragraph->id();
    
    $variables['heading_id'] = $heading_id;
    $variables['attributes']['id'] = $heading_id;
  }
  
  // Pass section_headings to featured content paragraph
  if ($paragraph->bundle() == 'featured_content') {
    // Get parent node to access section_headings
    $parent = $paragraph->getParentEntity();
    if ($parent && $parent->hasField('field_newsletter_content')) {
      $section_headings = [];
      
      foreach ($parent->field_newsletter_content as $paragraph_item) {
        $p = $paragraph_item->entity;
        
        if ($p && $p->bundle() == 'section_heading') {
          $heading_text = $p->field_section_heading->value;
          $heading_slug = _newsletter_create_slug($heading_text);
          $heading_id = $heading_slug . '-' . $p->id();
          
          $section_headings[] = [
            'id' => $heading_id,
            'text' => $heading_text,
          ];
        }
      }
      
      $variables['section_headings'] = $section_headings;
    }
  }
    $parent = $paragraph->getParentEntity();
  
  if ($parent && $parent->hasField('field_newsletter_type') && !$parent->get('field_newsletter_type')->isEmpty()) {
    foreach ($parent->get('field_newsletter_type') as $term) {
      $term_name = strtolower($term->entity->getName());
      if (strpos($term_name, '4-h') !== false || strpos($term_name, 'clover kids') !== false) {
        $variables['show_clover_logo'] = true;
        break;
      }
    }
  }
}

/**
 * Helper function to create URL-friendly slug.
 */
function _newsletter_create_slug($text) {
  $slug = strtolower(trim($text));
  $slug = preg_replace('/[^a-z0-9\s-]/', '', $slug);
  $slug = preg_replace('/[\s_]+/', '-', $slug);
  return preg_replace('/-+/', '-', $slug);
}

function newsletter_preprocess_page(&$variables) {
  $node = \Drupal::routeMatch()->getParameter('node');
  // Only for newsletter content type
  if (isset($variables['node']) && $variables['node']->bundle() == 'newsletter') {
    $node = $variables['node'];
    
    if ($node->hasField('field_newsletter_hero') && !$node->get('field_newsletter_hero')->isEmpty()) {
      $first_paragraph = $node->get('field_newsletter_hero')->first()->entity;
      
      if ($first_paragraph && $first_paragraph->hasField('field_newsletter_featured_image')) {
        $image_value = $first_paragraph->get('field_newsletter_featured_image')->value;
        
        if ($image_value) {
          $module_handler = \Drupal::service('extension.list.module');
          $module_path = $module_handler->getPath('newsletter');
          
          $extensions = ['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg'];
          $image_url = NULL;
          
          foreach ($extensions as $ext) {
            $file_path = DRUPAL_ROOT . '/' . $module_path . '/images/' . $image_value . '.' . $ext;
            if (file_exists($file_path)) {
              $image_url = base_path() . $module_path . '/images/' . $image_value . '.' . $ext;
              break;
            }
          }
          
          $variables['featured_image_url'] = $image_url;
          $variables['featured_image_name'] = $image_value;
        }
      }
    }
 // Check if the archive exclude checkbox is NOT checked
    $exclude_from_archive = $node->hasField('field_newsletter_archive_exclude') 
      ? $node->field_newsletter_archive_exclude->value 
      : false;
    
    if (!$exclude_from_archive) {
      
      // Get the creation/publication date
      $created_timestamp = $node->getCreatedTime();
      $current_timestamp = time();
      
      // Calculate if it's been 1 year (365 days)
      $one_year_seconds = 365 * 24 * 60 * 60;
      $age_seconds = $current_timestamp - $created_timestamp;
      
      if ($age_seconds >= $one_year_seconds) {
        // Show archive message
        $variables['show_archive_message'] = true;
        }
      }
  }
    if ($node && $node->hasField('field_newsletter_type') && !$node->get('field_newsletter_type')->isEmpty()) {
    foreach ($node->get('field_newsletter_type') as $term) {
      $term_name = strtolower($term->entity->getName());
      if (strpos($term_name, '4-h') !== false || strpos($term_name, 'clover kids') !== false) {
        $variables['show_clover_logo'] = true;
        break;
      }
    }
  }
}

/**
 * Implements hook_preprocess_block().
 */
function newsletter_preprocess_block(&$variables) {
  
 // Check if this is the save the date field block
  if ($variables['plugin_id'] == 'field_block:node:newsletter:field_newsletter_save_the_date') {
    
    $events = [];
    
    // Access the field render array at key 0
    if (isset($variables['content'][0])) {
      $field_render_array = $variables['content'][0];
      
      // Loop through the numeric keys in this field render array
      foreach ($field_render_array as $key => $item) {
        if (is_numeric($key)) {
          
          // Access paragraph
          if (isset($item['#paragraph'])) {
            $paragraph = $item['#paragraph'];
            
            // Get values
            $date_value = $paragraph->field_newsletter_event_date->value ?? '';
            $title = $paragraph->field_newsletter_event_title->value ?? '';
            $location = $paragraph->field_newsletter_event_location->value ?? '';
            $time = $paragraph->field_newsletter_event_time->value ?? '';
            
            // Format date
            $month = '';
            $day = '';
            if ($date_value) {
              try {
                $date_object = new \DateTime($date_value);
                $month = $date_object->format('M');
                $day = $date_object->format('j');
              } catch (\Exception $e) {
                // Log error but continue
                \Drupal::logger('newsletter')->error('Date parse error: @error', ['@error' => $e->getMessage()]);
              }
            }
            
            // Get link
            $link_url = '';
            if (!$paragraph->field_newsletter_event_link->isEmpty()) {
              $link_url = $paragraph->field_newsletter_event_link->uri;
            }
            
            $events[] = [
              'month' => $month,
              'day' => $day,
              'title' => $title,
              'time' => $time,
              'link' => $link_url,
              'location' => $location,
            ];
          }
        }
      }
    }
    
    $variables['events'] = $events;
  }
}

/**
 * Implements hook_preprocess_field().
 */
function newsletter_preprocess_field(&$variables) {
  $element = $variables['element'];
    // Target the specific entity reference field in the existing_content paragraph
  // Target the specific entity reference field in the existing_content paragraph
  if ($element['#field_name'] == 'field_existing_content_search' && 
      $element['#bundle'] == 'existing_content') {
    
    // Get the paragraph entity
    $paragraph = $element['#object'];
    $parent = $paragraph->getParentEntity();
    
    // Check if parent is a newsletter
    if ($parent && $parent->getEntityTypeId() == 'node' && $parent->bundle() == 'newsletter') {
      // Add context to all child items
      foreach ($variables['items'] as $delta => &$item) {
        if (isset($item['content']['#node'])) {
          $item['content']['#is_in_newsletter'] = TRUE;
          $item['content']['#newsletter_node'] = $parent;
        }
      }
    }
  }
  if ($variables['field_name'] == 'field_section_heading' && 
      isset($variables['element']['#bundle']) && 
      $variables['element']['#bundle'] == 'section_heading') {
    
    // Get the section heading paragraph
    $section_paragraph = $variables['element']['#object'];
    
    // Get the parent entity (the node)
    $parent = $section_paragraph->getParentEntity();
    
    if ($parent && $parent->hasField('field_newsletter_hero')) {
      
      // Get the hero/featured image paragraph
      if (!$parent->field_newsletter_hero->isEmpty()) {
        $hero_paragraph = $parent->field_newsletter_hero->entity;
        
        if ($hero_paragraph && $hero_paragraph->hasField('field_newsletter_featured_image')) {
          $image_value = $hero_paragraph->get('field_newsletter_featured_image')->value;
          
          if ($image_value) {
            $module_handler = \Drupal::service('extension.list.module');
            $module_path = $module_handler->getPath('newsletter');
            
            $extensions = ['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg'];
            
            foreach ($extensions as $ext) {
              $file_path = DRUPAL_ROOT . '/' . $module_path . '/images/' . $image_value . '.' . $ext;
              
              if (file_exists($file_path)) {
                $variables['background_image_url'] = base_path() . $module_path . '/images/' . $image_value . '.' . $ext;
                break;
              }
            }
          }
        }
      }
    }
  }

    if ($variables['field_name'] == 'field_section_heading') {
    $entity = $variables['element']['#object'];
    
    if ($entity && method_exists($entity, 'getParentEntity')) {
      $parent = $entity->getParentEntity();
      
      if ($parent && $parent->hasField('field_newsletter_type') && !$parent->get('field_newsletter_type')->isEmpty()) {
        foreach ($parent->get('field_newsletter_type') as $term) {
          $term_name = strtolower($term->entity->getName());
          if (strpos($term_name, '4-h') !== false || strpos($term_name, 'clover kids') !== false) {
            $variables['show_clover_logo'] = true;
            break;
          }
        }
      }
    }
  }
}

/**
 * Implements hook_views_pre_build().
 *
 * Adds newsletter fields and updates filters/text to the News Articles view
 * when the newsletter module is enabled.
 */
function newsletter_views_pre_build(ViewExecutable $view) {
  return;
  // Only affect the News Articles view.
  if ($view->id() !== 'news_articles') {
    return;
  }

  // Ensure all display handlers are loaded.
  $view->initDisplay();

  // --- Update displays that need changes ---
  $displays_to_update = ['attachment_2', 'block_1', 'page_1'];

  // Modify the default display
  $default_display = $view->displayHandlers->get('default');
  if ($default_display) {
    $filters = $default_display->getOption('filters');
    // Add newsletter to content type filter
    if (isset($filters['type'])) {
      $types = (array) $filters['type']['value'];
      if (!in_array('newsletter', $types, TRUE)) {
        $types[] = 'newsletter';
        $filters['type']['value'] = $types;
      }
    }
      // Add exclude newsletter value
      if (!isset($filters['field_newsletter_exclude_value'])) {
      $filters['field_newsletter_exclude_value'] = [
        'id' => 'field_newsletter_exclude_value',
        'table' => 'node__field_newsletter_exclude',
        'field' => 'field_newsletter_exclude_value',
        'plugin_id' => 'boolean',
        'operator' => '=',
        'value' => ['1'],
        'exposed' => FALSE,
      ];
    }
    else {
      $values = (array) $filters['field_newsletter_exclude_value']['value'];
      if (!in_array('1', $values, TRUE)) {
        $values[] = '1';
        $filters['field_newsletter_exclude_value']['value'] = $values;
      }
    }
        $default_display->setOption('filters', $filters);
  }

  // Loop through the displays we want to alter individually.
  foreach (['block_1', 'attachment_2', 'page_1'] as $display_id) {
    $display = $view->displayHandlers->get($display_id);
    if (!$display) {
      continue;
    }

    // Add newsletter to the content type filter
    $filters = $display->getOption('filters');
    if (isset($filters['type'])) {
      $types = (array) $filters['type']['value'];
      if (!in_array('newsletter', $types, TRUE)) {
        $types[] = 'newsletter';
        $filters['type']['value'] = $types;
        $display->setOption('filters', $filters);
      }
    }
    if ($display_id === 'page_1') {
    // Add exposed content type filter on Page
    $filters = $display->getOption('filters');
    if (isset($filters['type'])) {
      $filters['type']['expose']['operator'] = TRUE;
      $filters['type']['expose']['operator_id'] = 'type_op';
      $filters['type']['expose']['label'] = t('Filter by Type');
      $display->setOption('filters', $filters);
    }
  }

    // Add new fields for newsletter content
    $fields = $display->getOption('fields');

    if ($display_id === 'block_1') {
    // Add field_newsletter_thumbnail if missing.
    if (!isset($fields['field_newsletter_thumbnail'])) {
      $fields['field_newsletter_thumbnail'] = [
        'id' => 'field_newsletter_thumbnail',
        'table' => 'node__field_newsletter_thumbnail',
        'field' => 'field_newsletter_thumbnail',
        'plugin_id' => 'field',
        'exclude' => TRUE,
        'type' => 'media_thumbnail',
        'settings' => [
          'image_link' => '',
          'image_style' => 'news_articles_homepage_',
        ],
      ];
    }

    // Add field_newsletter_issue_date if missing.
    if (!isset($fields['field_newsletter_issue_date'])) {
      $fields['field_newsletter_issue_date'] = [
        'id' => 'field_newsletter_issue_date',
        'table' => 'node__field_newsletter_issue_date',
        'field' => 'field_newsletter_issue_date',
        'plugin_id' => 'field',
        'exclude' => TRUE,
        'type' => 'string',
        'settings' => ['link_to_entity' => 'FALSE']
      ];
    }

    // Add field_newsletter_featured if missing.
    if (!isset($fields['field_newsletter_featured'])) {
      $fields['field_newsletter_featured'] = [
        'id' => 'field_newsletter_featured',
        'table' => 'node__field_newsletter_featured',
        'field' => 'field_newsletter_featured',
        'plugin_id' => 'field',
        'exclude' => TRUE,
        'type' => 'entity_reference_revisions_entity_view',
        'settings' => ['view_mode' => 'default'],
      ];
    }

    // Update the rewrite block text for block display.
      if (isset($fields['nothing'])) {
        $fields['nothing']['alter']['text'] = <<<'EOT'
        <div class="card"> 
          <span class="bg-danger position-absolute">Featured</span> 
          <div class="card-image"> 
            {% if field_thumbnail is not empty %} {{ field_thumbnail }} {% endif %}
            {% if field_newsletter_thumbnail is not empty %} {{ field_newsletter_thumbnail }} {% endif %}
          </div> 
          <div class="card-body"> 
            <h3 class="card-title ext-news-feed--featured">{{ title }}</h3> 
            {% if field_newsletter_issue_date is empty %}<span class="authored-on">{{ created }}</span>{% endif %}
            {% if field_newsletter_issue_date is not empty %}<span class="authored-on">{{ field_newsletter_issue_date }} {% endif %}
            {% if field_teaser is not empty %}<div>{{ field_teaser }}</div>{% endif %}
            {% if field_newsletter_featured is not empty %}<div>{{ field_newsletter_featured }}</div>{% endif %}
          </div> 
        </div>
        EOT;
      }
    }
  elseif ($display_id === 'attachment_2') {
    // Add field_newsletter_thumbnail if missing.
    if (!isset($fields['field_newsletter_thumbnail'])) {
      $fields['field_newsletter_thumbnail'] = [
        'id' => 'field_newsletter_thumbnail',
        'table' => 'node__field_newsletter_thumbnail',
        'field' => 'field_newsletter_thumbnail',
        'plugin_id' => 'field',
        'exclude' => TRUE,
        'type' => 'media_thumbnail',
        'settings' => [
          'image_link' => '',
          'image_style' => 'news_articles_home_column',
        ],
      ];
    }
     // Add field_newsletter_issue_date if missing.
    if (!isset($fields['field_newsletter_issue_date'])) {
      $fields['field_newsletter_issue_date'] = [
        'id' => 'field_newsletter_issue_date',
        'table' => 'node__field_newsletter_issue_date',
        'field' => 'field_newsletter_issue_date',
        'plugin_id' => 'field',
        'exclude' => TRUE,
        'type' => 'string',
        'settings' => ['link_to_entity' => 'FALSE']
      ];
    }
      // Update the rewrite block text for block display.
      if (isset($fields['nothing'])) {
        $fields['nothing']['alter']['text'] = <<<'EOT'
        <div class="ext-news-column">
          <a class="card d-flex flex-row align-items-stretch" href="{{ view_node }}">
            <div class="card-image-list flex-shrink-0">
              {% if field_thumbnail is not empty %}{{ field_thumbnail }}{% endif %}
              {% if field_newsletter_thumbnail is not empty %}{{ field_newsletter_thumbnail }}{% endif %  
            </div>
          <div class="card-body">
            <h4 class="card-title">{{ title }}</h4>
            {% if field_newsletter_issue_date is empty %}<span class="authored-on">{{ created }}</span>{% endif %}
            {% if field_newsletter_issue_date is not empty %}<span class="authored-on">{{ field_newsletter_issue_date }}{% endif %}
          </div>
          <div class="card-arrow-wrapper">
            <span class="card-arrow"></span>
          </div>
          </a>
        </div>
        EOT;
      }
    }
  elseif ($display_id === 'page_1') {
    // Exclude field_thumbnail field.
    if (!isset($fields['field_thumbnail'])) {
      $fields['field_thumbnail'] = [
        'id' => 'field_thumbnail',
        'table' => 'node__field_thumbnail',
        'field' => 'field_thumbnail',
        'plugin_id' => 'field',
        'exclude' => TRUE,
        'type' => 'media_thumbnail',
        'settings' => [
          'image_link' => '',
          'image_style' => 'news_article_grid_',
        ],
      ];
    }
    // Add field_newsletter_thumbnail if missing.
    if (!isset($fields['field_newsletter_thumbnail'])) {
      $fields['field_newsletter_thumbnail'] = [
        'id' => 'field_newsletter_thumbnail',
        'table' => 'node__field_newsletter_thumbnail',
        'field' => 'field_newsletter_thumbnail',
        'plugin_id' => 'field',
        'exclude' => TRUE,
        'type' => 'media_thumbnail',
        'settings' => [
          'image_link' => '',
          'image_style' => 'news_article_grid_',
        ],
      ];
    }
    // Add Rewrite for Thumbnails.
    if (!isset($fields['nothing'])) {
      $fields['nothing']['alter']['text'] = <<<'EOT'
        {% if field_thumbnail is not empty %}{{ field_thumbnail }}{% endif %}
        {% if field_newsletter_thumbnail is not empty %}{{ field_newsletter_thumbnail }}{% endif %}
      EOT;
    }
    // Exclude created field.
    if (isset($fields['created'])) {
      $fields['created'] = [
        'exclude' => TRUE,
      ];
    }
    // Add field_newsletter_issue_date if missing.
    if (!isset($fields['field_newsletter_issue_date'])) {
      $fields['field_newsletter_issue_date'] = [
        'id' => 'field_newsletter_issue_date',
        'table' => 'node__field_newsletter_issue_date',
        'field' => 'field_newsletter_issue_date',
        'plugin_id' => 'field',
        'exclude' => TRUE,
        'alter' => [
          'alter_text' => TRUE,
          'text' => '<em>{{ field_newsletter_issue_date }}</em><br><b>{{ title }}</b>',
        ], 
        'type' => 'string',
        'settings' => ['link_to_entity' => 'FALSE']
      ];
    }
    // Add Rewrite for Authored On Info.
    if (!isset($fields['nothing_1'])) {
      $fields['nothing_1']['alter']['text'] = <<<'EOT'
        {% if field_newsletter_issue_date is empty %}<span class="authored-on">{{ created }}</span>{% endif %}
        {% if field_newsletter_issue_date is not empty %}<span class="authored-on">{{ field_newsletter_issue_date }}{% endif %}
      EOT;
    }
    // Add field_newsletter_featured if missing.
    if (!isset($fields['field_newsletter_featured'])) {
      $fields['field_newsletter_featured'] = [
        'id' => 'field_newsletter_featured',
        'table' => 'node__field_newsletter_featured',
        'field' => 'field_newsletter_featured',
        'plugin_id' => 'field',
        'exclude' => FALSE,
        'type' => 'entity_reference_revisions_entity_view',
        'settings' => ['view_mode' => 'default'],
      ];
    }

    // Save the updated field set.
    $display->setOption('fields', $fields);
    }
  }
}
/**
 * Implements hook_entity_operation().
 * 
 * Adds a "Newsletter Export" operation link to nodes.
 */
function newsletter_entity_operation($entity) {
  $operations = [];
  
  // Only add for nodes and if user has permission
  if ($entity instanceof NodeInterface && \Drupal::currentUser()->hasPermission('export newsletter content')) {
    if ($entity->bundle() == 'newsletter') {
      
      $operations['newsletter_export'] = [
        'title' => t('Newsletter Export'),
        'url' => \Drupal\Core\Url::fromRoute('newsletter.export', [
          'node' => $entity->id(),
        ]),
        'weight' => 50,
      ];
    }
  }
  
  return $operations;
}

/**
 * Implements hook_ENTITY_TYPE_view_alter() for nodes.
 * 
 * This ensures images are displayed with absolute URLs in the newsletter export.
 */
function newsletter_node_view_alter(array &$build, $entity, EntityViewDisplayInterface $display) {
  if ($display->getMode() == 'newsletter_export') {
    // Process image fields to use absolute URLs
    foreach ($build as $field_name => &$field) {
      // Make sure $field is an array and has the field_type key
      if (is_array($field) && isset($field['#field_type']) && $field['#field_type'] == 'image') {
        // Check if #items exists and is iterable
        if (isset($field['#items']) && is_iterable($field['#items'])) {
          foreach ($field['#items'] as $delta => $item) {
            if (isset($field[$delta]['#url'])) {
              $field[$delta]['#url'] = $field[$delta]['#url']->setAbsolute()->toString();
            }
            if (isset($field[$delta]['#item']->entity)) {
              $uri = $field[$delta]['#item']->entity->getFileUri();
              $field[$delta]['#image_style'] = NULL; // Optionally remove image styles
            }
          }
        }
      }
    }
  }
}

function newsletter_layout_builder_restrict_block_alter(array &$allowed_blocks, EntityInterface $entity, $context) {
  if (!\Drupal::moduleHandler()->moduleExists('newsletter')) {
    return;
  }

  $featured_block_id = 'views_block:newsletter-block_1';
  $archive_block_id = 'views_block:newsletter-block_2';
}
